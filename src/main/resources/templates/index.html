<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat - [[${channelName}]]</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-attachment: fixed;
        }

        .header-gradient {
            background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-gradient {
            background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.3s ease-out;
            margin-bottom: 12px;
        }

        .own-message {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        .other-message {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.3);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .own-message .message-sender {
            color: rgba(255, 255, 255, 0.9);
        }

        .other-message .message-sender {
            color: #93c5fd;
        }

        .message-content {
            color: white;
            line-height: 1.4;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #chatContainer {
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(10px);
        }

        #messages {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .channel-name {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .user-name {
            color: #93c5fd;
            font-weight: 600;
        }

        #content {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(75, 85, 99, 0.5);
            transition: all 0.3s ease;
        }

        #content:focus {
            background: rgba(30, 41, 59, 0.9);
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        #sendBtn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        #sendBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4);
        }

        #sendBtn:active {
            transform: translateY(0);
        }

        .exit-btn {
            background: linear-gradient(135deg, #dc2626, #ec4899);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3);
        }

        .exit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(220, 38, 38, 0.4);
        }

        /* Custom scrollbar */
        #chatContainer::-webkit-scrollbar {
            width: 6px;
        }

        #chatContainer::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
        }

        #chatContainer::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 10px;
        }

        /* Message status indicator */
        .message-status {
            display: flex;
            justify-content: flex-end;
            margin-top: 4px;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Online indicator */
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 5px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>
<body class="bg-black text-white flex flex-col h-screen">

<header class="header-gradient p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">Channel: <span class="channel-name" th:text="${channelName}">channel</span></h1>
    <div>User: <span class="user-name" th:text="${userName}">user</span> <span class="online-indicator"></span></div>
    <form action="/exit" method="POST">
        <input type="hidden" name="channelname" th:value="${channelName}" />
        <button type="submit" class="exit-btn">
            Exit
        </button>
    </form>
</header>

<input type="hidden" id="userName" th:value="${userName}" />
<input type="hidden" id="channelName" th:value="${channelName}" />

<footer class="footer-gradient p-4 flex gap-2">
    <input
            id="content"
            type="text"
            placeholder="Type your message..."
            maxlength="500"
            class="flex-grow rounded border border-gray-600 bg-black px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-white"
    />
    <button
            id="sendBtn"
            class="bg-black border border-gray-600 hover:border-white px-4 py-2 rounded text-white disabled:opacity-50 disabled:cursor-not-allowed"
    >
        Send
    </button>
</footer>

<script>
    const channelName = document.getElementById('channelName').value || 'defaultChannel';
    const userName = document.getElementById('userName').value || 'Anonymous';

    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            document.getElementById('sendBtn').disabled = false;

            stompClient.subscribe('/topic/messages/' + channelName, function (message) {
                showMessage(JSON.parse(message.body));
            });
        }, function(error) {
            console.error('Connection error:', error);
            document.getElementById('sendBtn').disabled = true;
        });
    }

    function sendMessage() {
        const contentInput = document.getElementById('content');
        const content = contentInput.value.trim();

        if (!content) {
            alert('Please enter a message');
            return;
        }

        const message = {
            channelName: channelName,
            content: content,
            from: userName
        };

        if (stompClient && stompClient.connected) {
            stompClient.send("/app/send", {}, JSON.stringify(message));
            contentInput.value = '';
            contentInput.focus();
        } else {
            alert("Not connected to chat server.");
        }
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const msgDiv = document.createElement('div');
        const isOwnMessage = message.from === userName;

        msgDiv.className = isOwnMessage ? 'message-bubble own-message' : 'message-bubble other-message';

        const senderDiv = document.createElement('div');
        senderDiv.className = 'message-sender';
        senderDiv.textContent = isOwnMessage ? 'You' : message.from;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = message.content;

        msgDiv.appendChild(senderDiv);
        msgDiv.appendChild(contentDiv);

        if (isOwnMessage) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message-status';
            statusDiv.textContent = 'Sent';
            msgDiv.appendChild(statusDiv);
        }

        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('content').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    connect();
</script>

</body>
</html>