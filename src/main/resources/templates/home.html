<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat - [[${channelName}]]</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white flex flex-col h-screen">

    <header class="bg-black p-4 flex justify-between items-center border-b border-gray-700">
        <h1 class="text-xl font-semibold">Channel: <span th:text="${channelName}">channel</span></h1>
        <div>User: <span th:text="${userName}">user</span></div>
        <form action="/exit" method="POST">
            <input type="hidden" name="channelname" th:value="${channelName}" />
            <button type="submit">
                Exit
            </button>
        </form>
    </header>

    <main id="chatContainer" class="flex-1 overflow-auto p-4 space-y-4 bg-black">
        <div id="messages" class="flex flex-col space-y-3"></div>
    </main>
    <input type="hidden" id="userName" th:value="${userName}" />
    <input type="hidden" id="channelName" th:value="${channelName}" />

    <footer class="bg-black p-4 flex gap-2 border-t border-gray-700">
        <input
            id="content"
            type="text"
            placeholder="Type your message..."
            maxlength="500"
            class="flex-grow rounded border border-gray-600 bg-black px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-white"
        />
        <button
            id="sendBtn"
            class="bg-black border border-gray-600 hover:border-white px-4 py-2 rounded text-white disabled:opacity-50 disabled:cursor-not-allowed"
        >
            Send
        </button>
    </footer>

<script>
    const channelName = document.getElementById('channelName').value || 'defaultChannel';
    const userName = document.getElementById('userName').value || 'Anonymous';

    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws'); 
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            document.getElementById('sendBtn').disabled = false;

            stompClient.subscribe('/topic/messages/' + channelName, function (message) {
                showMessage(JSON.parse(message.body));
            });
        }, function(error) {
            console.error('Connection error:', error);
            document.getElementById('sendBtn').disabled = true;
        });
    }

    function sendMessage() {
        const contentInput = document.getElementById('content');
        const content = contentInput.value.trim();

        if (!content) {
            alert('Please enter a message');
            return;
        }

        const message = {
            channelName: channelName,
            content: content,
            from: userName
        };

        if (stompClient && stompClient.connected) {
            stompClient.send("/app/send", {}, JSON.stringify(message));
            contentInput.value = '';
            contentInput.focus();
        } else {
            alert("Not connected to chat server.");
        }
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const msgDiv = document.createElement('div');
        const isOwnMessage = message.from === userName;

        msgDiv.className = isOwnMessage
            ? 'self-end bg-black border border-gray-600 px-4 py-2 rounded-lg max-w-xs break-words text-white'
            : 'self-start bg-black border border-gray-600 px-4 py-2 rounded-lg max-w-xs break-words text-white';

        msgDiv.innerHTML = `<strong>${message.from}</strong><br/>${message.content}`;

        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('content').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    connect();
</script>

</body>
</html>
